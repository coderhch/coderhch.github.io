---
title: 事务传播机制
tags:
  - java
  - springBoot
cover: https://coderhch.oss-cn-shanghai.aliyuncs.com/blog/2021-05-23/%E4%BA%8B%E5%8A%A1/65039908_p0_master1200.jpg
date: 2021-05-23
categories: springBoot
---

# 事务传播机制

## 非事务运行

```java
@Service
public class StuServiceImpl implements StuService {

    @Autowired
    public StuMapper stuMapper;

    public void saveParent() {
        Stu stu = new Stu();
        stu.setName("parent");
        stu.setAge(19);
        stuMapper.insert(stu);
    }

    public void saveChildren() {
        saveChild1();
        int a = 1 / 0;
        saveChild2();
    }

    public void saveChild1() {
        Stu stu1 = new Stu();
        stu1.setName("child-1");
        stu1.setAge(11);
        stuMapper.insert(stu1);
    }
    public void saveChild2() {
        Stu stu2 = new Stu();
        stu2.setName("child-2");
        stu2.setAge(22);
        stuMapper.insert(stu2);
    }
}
```

```java
@Service
public class TestTransServiceImpl implements TestTransService {

    @Autowired
    private StuService stuService;

    @Override
    public void testPropagationTrans() {
        stuService.saveParent();
        stuService.saveChildren();
    }
}
```

```java

@RunWith(SpringRunner.class)
@SpringBootTest(classes = Application.class)
public class TransTest {
    @Autowired
    private TestTransService testTransService;

    @Test
    public void myTest() {
        testTransService.testPropagationTrans();
    }

}
```

<img src="https://coderhch.oss-cn-shanghai.aliyuncs.com/blog/2021-05-23/%E4%BA%8B%E5%8A%A1/1621766006%281%29.jpg" style="zoom:50%;" />

## REQUIRED

说明：

- 使用当前的事务，如果当前没有事务，则自己新建一个事务，子方法是必须运行在一个事务中的；
- 如果当前存在事务，则加入这个事务，成为一个整体。

1. 外层 REQUIRED 事务

```java
@Transactional(propagation = Propagation.REQUIRED)
@Override
public void testPropagationTrans() {
    stuService.saveParent();
    stuService.saveChildren();
}
```

<img src="https://coderhch.oss-cn-shanghai.aliyuncs.com/blog/2021-05-23/%E4%BA%8B%E5%8A%A1/2.png" style="zoom:50%;" />

2. 内层 REQUIRED 事务

```java
@Transactional(propagation = Propagation.REQUIRED)
public void saveChildren() {
    saveChild1();
    int a = 1 / 0;
    saveChild2();
}
```

<img src="https://coderhch.oss-cn-shanghai.aliyuncs.com/blog/2021-05-23/%E4%BA%8B%E5%8A%A1/3.jpg" style="zoom:50%;" />

## SUPPORTS

说明：

- 如果当前有事务，则使用事务；如果当前没有事务，则不使用事务。

1. 内存 SUPPORTS 事务

```java
@Transactional(propagation = Propagation.SUPPORTS)
public void saveChildren() {
	saveChild1();
	int a = 1 / 0;
	saveChild2();
}
```

<img src="https://coderhch.oss-cn-shanghai.aliyuncs.com/blog/2021-05-23/%E4%BA%8B%E5%8A%A1/4.jpg" style="zoom:50%;" />

2. 外层 REQUIRED 事务，内层 SUPPORTS 事务

```java
@Transactional(propagation = Propagation.SUPPORTS)
public void saveChildren() {
	saveChild1();
	int a = 1 / 0;
	saveChild2();
}
```

```java
@Transactional(propagation = Propagation.REQUIRED)
@Override
public void testPropagationTrans() {
	stuService.saveParent();
	stuService.saveChildren();
}
```

<img src="https://coderhch.oss-cn-shanghai.aliyuncs.com/blog/2021-05-23/%E4%BA%8B%E5%8A%A1/2.png" style="zoom:50%;" />

## MANDATORY

说明：

- 该传播属性强制必须存在一个事务，如果不存在，则抛出异常

1. 内层 MANDATORY 事务

```java
@Transactional(propagation = Propagation.MANDATORY)
public void saveChildren() {
	saveChild1();
	saveChild2();
}
```

`org.springframework.transaction.IllegalTransactionStateException: No existing transaction found for transaction marked with propagation 'mandatory'`报错

## REQUIRES_NEW

说明：

- 如果当前有事务，则挂起该事务，并且自己创建一个新的事务给自己使用；
- 如果当前没有事务，则同 REQUIRED

1. 内层 REQUIRES_NEW 事务，外层 REQUIRES 事务

```java
@Transactional(propagation = Propagation.REQUIRED)
@Override
public void testPropagationTrans() {
	stuService.saveParent();
	stuService.saveChildren();
	int a = 1 / 0;
}
```

```java
@Transactional(propagation = Propagation.REQUIRES_NEW)
public void saveChildren() {
	saveChild1();
	saveChild2();
}
```

<img src="https://coderhch.oss-cn-shanghai.aliyuncs.com/blog/2021-05-23/%E4%BA%8B%E5%8A%A1/6.jpg" style="zoom:50%;" />

## NOT_SUPPORTED

说明：

- 如果当前有事务，则把事务挂起，自己不适用事务去运行数据库操作

1. 外层 REQUIRED 事务，内层 NOT_SUPPORTED 事务

```java
@Transactional(propagation = Propagation.REQUIRED)
@Override
public void testPropagationTrans() {
	stuService.saveParent();
	stuService.saveChildren();
}
```

```java
@Transactional(propagation = Propagation.NOT_SUPPORTED)
public void saveChildren() {
	saveChild1();
	int a = 1 / 0;
	saveChild2();
}
```

<img src="https://coderhch.oss-cn-shanghai.aliyuncs.com/blog/2021-05-23/%E4%BA%8B%E5%8A%A1/7.jpg" style="zoom:50%;" />

## NEVER

说明：

- 如果当前有事务存在，则抛出异常

1. 外层 REQUIRED 事务，内层 NEVER 事务

```java
@Transactional(propagation = Propagation.NEVER)
public void saveChildren() {
	saveChild1();
	int a = 1 / 0;
	saveChild2();
}
```

```java
@Transactional(propagation = Propagation.REQUIRED)
@Override
public void testPropagationTrans() {
	stuService.saveParent();
	stuService.saveChildren();
}
```

`org.springframework.transaction.IllegalTransactionStateException: Existing transaction found for transaction marked with propagation 'never'`

## NESTED

说明：

- 如果当前有事务，则开启子事务（嵌套事务），嵌套事务是独立提交或者回滚；
- 如果当前没有事务，则同 REQUIRED；
- 但是如果主事务提交，则会携带子事务一起提交；
- 如果主事务回滚，则子事务会一起回滚。相反，子事务异常，则父事务可以回滚或不回滚；

1. 外层 REQUIRED，内层 NEVER 事务

```java
@Transactional(propagation = Propagation.NEVER)
public void saveChildren() {
	saveChild1();
	saveChild2();
}
```

```java
@Transactional(propagation = Propagation.REQUIRED)
@Override
public void testPropagationTrans() {
	stuService.saveParent();
	stuService.saveChildren();
	int a = 1/0;
}
```

<img src="https://coderhch.oss-cn-shanghai.aliyuncs.com/blog/2021-05-23/%E4%BA%8B%E5%8A%A1/2.png" style="zoom:50%;" />
