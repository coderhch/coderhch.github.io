---
title: Semaphore：信号量，允许多个线程同时访问
tags: 
    - java
    - 多线程
    - 锁
date: 2020-09-16
cover: https://coderhch.oss-cn-shanghai.aliyuncs.com/%E5%8D%9A%E5%AE%A2%E5%9B%BE%E7%89%87/2020_02_17_00_42_IMG_0943.JPG
---

### Semaphore：信号量，允许多个线程同时访问

信号量为多线程协作提供了更为强大的控制方法。从广义上说信号量是对锁的扩展。无论是内部锁**synchronized**还是重入锁**ReentrantLock**，一次都只允许一个线程访问一个资源，而信号量却可以指定多个线程，同时访问某一个资源。信号量主要提供了以下构造函数：

```java
public Semaphore(int permits) {sync = new NonfairSync(permits);}
public Semaphore(int permits, boolean fair) {sync = fair ? new FairSync(permits) : new NonfairSync(permits);}
```

在构造信号量对象时，必须要指定信号量的准入数，即同时能申请多少个许可。当每个线程每次只申请一个许可时，这就相当于指定了同时有多少个线程可以访问某一个资源。信号量的主要逻辑方法有：

```java
public void acquire()
ublic void acquireUninterruptibly()
public boolean tryAcquire
public boolean tryAcquire(long timeout, TimeUnit unit)
public void release() 
```

- `acquire()`方法尝试获得一个准入的许可。若无法获得，则线程会等待，直到有线程释放一个许可或者当前线程被中断。
- `acquireUninterruptibly()`方法和`acquire()`方法类似，但是不响应中断。
- `tryAcquire()`方法尝试获得一个许可，如果成功返回`true`，失败则返回`false`，它不会进行等待，立即返回。
- `release()`方法用于在线程访问资源结束后释放一个许可，以使其他等待许可的线程可以进行资源访问。

在JDK的官方Javadoc中，就有一个有关信号量使用的简单实例这里给出一个更简单的例子：

```java
public class SemapDemo implements Runnable {
    final Semaphore  semaphore =new Semaphore(5);
    
    @Override
    public void run() {
        try {
            semaphore.acquire();
            Thread.sleep(2000);
            System.out.println(Thread.currentThread().getId()+":done!");
        } catch (InterruptedException e) {
            e.printStackTrace();
        } finally {
            semaphore.release();
        }
    }

    public static void main(String[] args) {
        ExecutorService exec= Executors.newFixedThreadPool(20);
        final SemapDemo semapDemo=new SemapDemo();
        for (int i=0;i<20;i++){
            exec.submit(semapDemo);
        }
    }
}
```

第2行 代码声明了一个包含5个许可的信号量。这就意味着同时可以有5个线程进入代码段第7~9行。第7~9行为临界区管理代码，程序会限制执行这段代码的线程数。申请信号量使用`acquire()`方法操作，在离开时，务必使用`release()`方法释放信号量（代码第13行）。这就释放锁是一个道理。如果不幸发生了信号量的泄露（申请了但没有释放），那么可以进入临界区的线程数量就会越来越少，直到所有的线程均不可访问。在本例中，同时开启20个线程。观察这段程序的输出，你就会发现系统以5个线程一组为单位，依次输出带有线程ID的提示文本。

